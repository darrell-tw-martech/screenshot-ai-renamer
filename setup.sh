#!/bin/bash

# å®šç¾©é¡è‰²ï¼Œè®“ä»‹é¢çœ‹èµ·ä¾†åƒç¾ä»£åŒ– CLI
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}==============================================${NC}"
echo -e "${BLUE}   ðŸ¤– Gemini Screenshot Auto-Renamer Setup    ${NC}"
echo -e "${BLUE}==============================================${NC}"
echo ""

# 1. æª¢æŸ¥ä¸¦åµæ¸¬ Gemini æŒ‡ä»¤ä½ç½®
echo -e "${YELLOW}[1/4] æ­£åœ¨å°‹æ‰¾ Gemini CLI...${NC}"
if command -v gemini &> /dev/null; then
    DETECTED_GEMINI=$(which gemini)
    echo -e "${GREEN}âœ“ ç™¼ç¾ Gemini æŒ‡ä»¤æ–¼: $DETECTED_GEMINI${NC}"
    GEMINI_CMD="$DETECTED_GEMINI"
else
    echo -e "${RED}âœ— æ‰¾ä¸åˆ° 'gemini' æŒ‡ä»¤ã€‚${NC}"
    read -p "è«‹è¼¸å…¥ gemini åŸ·è¡Œæª”çš„çµ•å°è·¯å¾‘ (ä¾‹å¦‚ /opt/homebrew/bin/gemini): " USER_GEMINI
    GEMINI_CMD="$USER_GEMINI"
fi

echo ""

# 2. æ™ºæ…§åµæ¸¬ macOS æˆªåœ–è·¯å¾‘
echo -e "${YELLOW}[2/4] æ­£åœ¨åµæ¸¬ç³»çµ±æˆªåœ–è³‡æ–™å¤¾...${NC}"
# ä½¿ç”¨ macOS defaults æŒ‡ä»¤è®€å–çœŸå¯¦è¨­å®š
SYSTEM_SCREENSHOT_DIR=$(defaults read com.apple.screencapture location 2>/dev/null)

# å¦‚æžœè®€ä¸åˆ°ï¼Œé è¨­ç‚ºæ¡Œé¢
if [ -z "$SYSTEM_SCREENSHOT_DIR" ]; then
    SYSTEM_SCREENSHOT_DIR="$HOME/Desktop"
fi

# æ“´å±• ~ ç‚ºå®Œæ•´è·¯å¾‘
SYSTEM_SCREENSHOT_DIR="${SYSTEM_SCREENSHOT_DIR/#\~/$HOME}"

echo -e "åµæ¸¬åˆ°çš„æˆªåœ–è·¯å¾‘ç‚º: ${BLUE}$SYSTEM_SCREENSHOT_DIR${NC}"
read -p "æ˜¯å¦è¦ç›£æŽ§æ­¤è³‡æ–™å¤¾? (y/n) [é è¨­: y]: " CONFIRM_SS
CONFIRM_SS=${CONFIRM_SS:-y}

WATCH_DIRS=()
if [[ "$CONFIRM_SS" =~ ^[Yy]$ ]]; then
    WATCH_DIRS+=("$SYSTEM_SCREENSHOT_DIR")
fi

echo ""

# 3. è©¢å•é¡å¤–è³‡æ–™å¤¾ (ä¾‹å¦‚ Blog)
echo -e "${YELLOW}[3/4] è¨­å®šé¡å¤–ç›£æŽ§è³‡æ–™å¤¾${NC}"
echo "æ‚¨æ˜¯å¦é‚„æœ‰å…¶ä»–è³‡æ–™å¤¾éœ€è¦ AI è‡ªå‹•æ”¹åï¼Ÿ(ä¾‹å¦‚ Blog æ–‡ç« ç›®éŒ„)"
echo "å¦‚æžœä¸åŠ ï¼Œè«‹ç›´æŽ¥æŒ‰ Enter è·³éŽã€‚"

while true; do
    read -p "è«‹è¼¸å…¥è·¯å¾‘ (æˆ–æŒ‰ Enter çµæŸ): " EXTRA_DIR
    if [ -z "$EXTRA_DIR" ]; then
        break
    fi
    
    # è™•ç† ~ ç¬¦è™Ÿ
    EXTRA_DIR="${EXTRA_DIR/#\~/$HOME}"

    if [ -d "$EXTRA_DIR" ]; then
        WATCH_DIRS+=("$EXTRA_DIR")
        echo -e "${GREEN}âœ“ å·²åŠ å…¥: $EXTRA_DIR${NC}"
    else
        echo -e "${RED}âš ï¸  è·¯å¾‘ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°ç¢ºèªã€‚${NC}"
    fi
done

echo ""

# 4. ç”Ÿæˆ .env æª”æ¡ˆ
echo -e "${YELLOW}[4/4] æ­£åœ¨ç”Ÿæˆè¨­å®šæª” (.env)...${NC}"

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
ENV_FILE="$SCRIPT_DIR/.env"
LOG_FILE="$SCRIPT_DIR/monitor.log"

# æ§‹å»º Watch Dirs å­—ä¸²
DIRS_STRING=""
for dir in "${WATCH_DIRS[@]}"; do
    DIRS_STRING+="    \"$dir\""$à®µà¯ˆà®¯à¯ˆ'
'
done

cat > "$ENV_FILE" <<EOF
# ==============================================
# AI Auto-Rename Screenshot - Configuration File
# Generated by setup.sh on $(date)
# ==============================================

# [Required] Directories to monitor
WATCH_DIRS=(
$DIRS_STRING)

# [Optional] Path to the 'gemini' executable
GEMINI_CMD="$GEMINI_CMD"

# [Optional] Log file path
LOG_FILE="$LOG_FILE"
EOF

echo -e "${GREEN}âœ… è¨­å®šå®Œæˆï¼å·²å»ºç«‹ .env æª”æ¡ˆã€‚${NC}"
echo ""
echo -e "æ‚¨ç¾åœ¨å¯ä»¥åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†æ¸¬è©¦ï¼š"
echo -e "${BLUE}./monitor_gemini.sh${NC}"
